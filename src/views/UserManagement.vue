<template>
  <div class="user-management-container">
    <div class="header">
      <h2 class="system-title">ÁΩëÁªúÂÆâÂÖ®Áî®Êà∑ÁÆ°ÁêÜÁ≥ªÁªü</h2>
      <div class="operation-area">
        <el-input
          v-model="searchQuery"
          placeholder="ÊêúÁ¥¢Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±"
          clearable
          style="width: 300px"
          @clear="handleSearchClear"
          @keyup.enter="handleSearch"
          class="security-search"
        >
          <template #append>
            <el-button @click="handleSearch" class="search-btn">
              <span class="search-icon">üîç</span>
            </el-button>
          </template>
        </el-input>
        <el-button type="primary" @click="showAddDialog = true" class="add-user-btn">
          <span class="btn-icon">+</span> Ê∑ªÂä†Áî®Êà∑
        </el-button>
      </div>
    </div>

    <el-table
      :data="filteredUsers"
      border
      style="width: 100%"
      v-loading="loading"
      :row-class-name="tableRowClassName"
      class="security-table"
    >
      <el-table-column prop="id" label="ID" width="80" align="center" />
      <el-table-column prop="username" label="Áî®Êà∑Âêç" width="120" />
      <el-table-column prop="email" label="ÈÇÆÁÆ±" width="200" />
      <el-table-column prop="role" label="ËßíËâ≤" width="120">
        <template #default="scope">
          <el-tag :type="getRoleTagType(scope.row.role)" effect="light">
            {{ scope.row.role }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="status" label="Áä∂ÊÄÅ" width="100" align="center">
        <template #default="scope">
          <el-switch
            v-model="scope.row.status"
            active-value="active"
            inactive-value="inactive"
            active-text="ÂêØÁî®"
            inactive-text="Á¶ÅÁî®"
            @change="handleStatusChange(scope.row)"
          />
        </template>
      </el-table-column>
      <el-table-column prop="lastLogin" label="ÊúÄÂêéÁôªÂΩï" width="180" />
      <el-table-column label="Êìç‰Ωú" width="180" fixed="right" align="center">
        <template #default="scope">
          <el-button
            size="small"
            @click="handleEdit(scope.row)"
            class="edit-btn"
          >‚úèÔ∏è ÁºñËæë</el-button>
          <el-button
            size="small"
            type="danger"
            @click="handleDelete(scope.row)"
            class="delete-btn"
          >üóëÔ∏è Âà†Èô§</el-button>
        </template>
      </el-table-column>
    </el-table>

    <div class="pagination-container">
      <el-pagination
        v-model:current-page="currentPage"
        v-model:page-size="pageSize"
        :page-sizes="[10, 20, 30, 50]"
        layout="total, sizes, prev, pager, next, jumper"
        :total="totalUsers"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        class="security-pagination"
      />
    </div>

    <!-- Ê∑ªÂä†Áî®Êà∑ÂØπËØùÊ°Ü -->
    <el-dialog v-model="showAddDialog" title="Ê∑ªÂä†Êñ∞Áî®Êà∑" width="500" class="security-dialog">
      <el-form :model="newUserForm" label-width="100px" label-position="left">
        <el-form-item label="Áî®Êà∑Âêç" required>
          <el-input v-model="newUserForm.username" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" />
        </el-form-item>
        <el-form-item label="ÈÇÆÁÆ±" required>
          <el-input v-model="newUserForm.email" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" />
        </el-form-item>
        <el-form-item label="ÂØÜÁ†Å" required>
          <el-input v-model="newUserForm.password" type="password" show-password placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" />
          <div class="password-strength">
            <span :class="{'weak': passwordStrength === 'weak'}">Âº±</span>
            <span :class="{'medium': passwordStrength === 'medium'}">‰∏≠</span>
            <span :class="{'strong': passwordStrength === 'strong'}">Âº∫</span>
          </div>
        </el-form-item>
        <el-form-item label="ËßíËâ≤" required>
          <el-select v-model="newUserForm.role" placeholder="ËØ∑ÈÄâÊã©ËßíËâ≤">
            <el-option label="ÁÆ°ÁêÜÂëò" value="admin" />
            <el-option label="Êìç‰ΩúÂëò" value="operator" />
            <el-option label="ÂÆ°ËÆ°Âëò" value="auditor" />
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showAddDialog = false" class="cancel-btn">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="handleAddUser" class="confirm-btn">Á°ÆËÆ§Ê∑ªÂä†</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- ÁºñËæëÁî®Êà∑ÂØπËØùÊ°Ü -->
    <el-dialog v-model="showEditDialog" title="ÁºñËæëÁî®Êà∑‰ø°ÊÅØ" width="500" class="security-dialog">
      <el-form :model="editUserForm" label-width="100px" label-position="left">
        <el-form-item label="Áî®Êà∑Âêç">
          <el-input v-model="editUserForm.username" disabled />
        </el-form-item>
        <el-form-item label="ÈÇÆÁÆ±" required>
          <el-input v-model="editUserForm.email" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" />
        </el-form-item>
        <el-form-item label="ÂØÜÁ†Å">
          <el-input v-model="editUserForm.password" type="password" show-password placeholder="ÁïôÁ©∫Âàô‰∏ç‰øÆÊîπ" />
        </el-form-item>
        <el-form-item label="ËßíËâ≤" required>
          <el-select v-model="editUserForm.role" placeholder="ËØ∑ÈÄâÊã©ËßíËâ≤">
            <el-option label="ÁÆ°ÁêÜÂëò" value="admin" />
            <el-option label="Êìç‰ΩúÂëò" value="operator" />
            <el-option label="ÂÆ°ËÆ°Âëò" value="auditor" />
          </el-select>
        </el-form-item>
        <el-form-item label="Áä∂ÊÄÅ" required>
          <el-switch
            v-model="editUserForm.status"
            active-value="active"
            inactive-value="inactive"
            active-text="ÂêØÁî®"
            inactive-text="Á¶ÅÁî®"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showEditDialog = false" class="cancel-btn">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="handleEditSubmit" class="confirm-btn">Á°ÆËÆ§‰øÆÊîπ</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- ÂÆâÂÖ®ÂÆ°ËÆ°Êó•ÂøóÂºπÁ™ó -->
    <el-dialog v-model="showAuditLog" title="ÂÆâÂÖ®ÂÆ°ËÆ°Êó•Âøó" width="700" class="audit-log-dialog">
      <el-table :data="auditLogs" border style="width: 100%">
        <el-table-column prop="time" label="Êó∂Èó¥" width="150" />
        <el-table-column prop="action" label="Êìç‰Ωú" width="120" />
        <el-table-column prop="operator" label="Êìç‰Ωú‰∫∫" width="120" />
        <el-table-column prop="target" label="ÁõÆÊ†áÁî®Êà∑" width="120" />
        <el-table-column prop="details" label="ËØ¶ÁªÜ‰ø°ÊÅØ" />
      </el-table>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'

// Ê®°ÊãüÊï∞ÊçÆ
const mockUsers = Array.from({ length: 50 }, (_, i) => ({
  id: i + 1,
  username: `user${i + 1}`,
  email: `user${i + 1}@example.com`,
  role: ['admin', 'operator', 'auditor'][Math.floor(Math.random() * 3)],
  status: Math.random() > 0.3 ? 'active' : 'inactive',
  lastLogin: new Date(Date.now() - Math.floor(Math.random() * 7 * 24 * 60 * 60 * 1000)).toLocaleString(),
}))

// Ê®°ÊãüÂÆ°ËÆ°Êó•Âøó
const mockAuditLogs = [
  {
    time: new Date().toLocaleString(),
    action: 'Ê∑ªÂä†Áî®Êà∑',
    operator: 'admin',
    target: 'user51',
    details: 'Ê∑ªÂä†‰∫ÜÊñ∞Áî®Êà∑user51ÔºåËßíËâ≤‰∏∫Êìç‰ΩúÂëò'
  },
  {
    time: new Date(Date.now() - 1000 * 60 * 5).toLocaleString(),
    action: '‰øÆÊîπÁä∂ÊÄÅ',
    operator: 'admin',
    target: 'user12',
    details: 'Â∞ÜÁî®Êà∑user12Áä∂ÊÄÅ‰øÆÊîπ‰∏∫Á¶ÅÁî®'
  },
  {
    time: new Date(Date.now() - 1000 * 60 * 30).toLocaleString(),
    action: 'Âà†Èô§Áî®Êà∑',
    operator: 'auditor1',
    target: 'user7',
    details: 'Âà†Èô§‰∫ÜÁî®Êà∑user7'
  }
]

// Áä∂ÊÄÅÁÆ°ÁêÜ
const users = ref([])
const loading = ref(false)
const searchQuery = ref('')
const currentPage = ref(1)
const pageSize = ref(10)
const totalUsers = ref(0)
const showAddDialog = ref(false)
const showEditDialog = ref(false)
const showAuditLog = ref(false)
const auditLogs = ref(mockAuditLogs)

// Ë°®ÂçïÊï∞ÊçÆ
const newUserForm = ref({
  username: '',
  email: '',
  password: '',
  role: 'operator',
})

const editUserForm = ref({
  id: 0,
  username: '',
  email: '',
  password: '',
  role: '',
  status: 'active',
})

// ÂØÜÁ†ÅÂº∫Â∫¶ËÆ°ÁÆó
const passwordStrength = computed(() => {
  if (!newUserForm.value.password) return ''
  if (newUserForm.value.password.length < 6) return 'weak'
  if (newUserForm.value.password.length < 10) return 'medium'
  return 'strong'
})

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredUsers = computed(() => {
  let result = users.value
  
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    result = result.filter(
      user =>
        user.username.toLowerCase().includes(query) ||
        user.email.toLowerCase().includes(query)
    )
  }
  
  totalUsers.value = result.length
  
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  
  return result.slice(start, end)
})

// ÊñπÊ≥ï
const fetchUsers = () => {
  loading.value = true
  // Ê®°ÊãüÂºÇÊ≠•Âä†ËΩΩ
  setTimeout(() => {
    users.value = mockUsers
    totalUsers.value = mockUsers.length
    loading.value = false
    // ËÆ∞ÂΩïÂÆ°ËÆ°Êó•Âøó
    addAuditLog('Êü•ÁúãÁî®Êà∑ÂàóË°®', 'Á≥ªÁªü', '', 'Âä†ËΩΩ‰∫ÜÊâÄÊúâÁî®Êà∑Êï∞ÊçÆ')
  }, 800)
}

const handleSearch = () => {
  currentPage.value = 1
  addAuditLog('ÊêúÁ¥¢Áî®Êà∑', 'Á≥ªÁªü', '', `ÊêúÁ¥¢ÂÖ≥ÈîÆËØç: ${searchQuery.value}`)
}

const handleSearchClear = () => {
  currentPage.value = 1
}

const handleSizeChange = (val) => {
  pageSize.value = val
}

const handleCurrentChange = (val) => {
  currentPage.value = val
}

const handleAddUser = () => {
  if (!newUserForm.value.username || !newUserForm.value.email || !newUserForm.value.password) {
    ElMessage.warning('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ')
    return
  }
  
  // Ê£ÄÊü•Áî®Êà∑ÂêçÊòØÂê¶Â∑≤Â≠òÂú®
  if (users.value.some(user => user.username === newUserForm.value.username)) {
    ElMessage.warning('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®')
    return
  }
  
  // Ê£ÄÊü•ÈÇÆÁÆ±ÊòØÂê¶Â∑≤Â≠òÂú®
  if (users.value.some(user => user.email === newUserForm.value.email)) {
    ElMessage.warning('ÈÇÆÁÆ±Â∑≤Ë¢´Ê≥®ÂÜå')
    return
  }
  
  const newUser = {
    id: users.value.length + 1,
    username: newUserForm.value.username,
    email: newUserForm.value.email,
    role: newUserForm.value.role,
    status: 'active',
    lastLogin: new Date().toLocaleString(),
  }
  
  users.value.unshift(newUser)
  showAddDialog.value = false
  ElMessage.success('Ê∑ªÂä†Áî®Êà∑ÊàêÂäü')
  
  // ËÆ∞ÂΩïÂÆ°ËÆ°Êó•Âøó
  addAuditLog('Ê∑ªÂä†Áî®Êà∑', 'admin', newUser.username, `Ê∑ªÂä†‰∫ÜÊñ∞Áî®Êà∑: ${newUser.username}, ËßíËâ≤: ${newUser.role}`)
  
  // ÈáçÁΩÆË°®Âçï
  newUserForm.value = {
    username: '',
    email: '',
    password: '',
    role: 'operator',
  }
}

const handleEdit = (user) => {
  editUserForm.value = {
    id: user.id,
    username: user.username,
    email: user.email,
    password: '',
    role: user.role,
    status: user.status,
  }
  showEditDialog.value = true
}

const handleEditSubmit = () => {
  if (!editUserForm.value.email) {
    ElMessage.warning('ËØ∑Â°´ÂÜôÈÇÆÁÆ±')
    return
  }
  
  const index = users.value.findIndex(user => user.id === editUserForm.value.id)
  if (index !== -1) {
    const oldData = {...users.value[index]}
    users.value[index].email = editUserForm.value.email
    users.value[index].role = editUserForm.value.role
    users.value[index].status = editUserForm.value.status
    
    if (editUserForm.value.password) {
      // Ê®°ÊãüÂØÜÁ†ÅÊõ¥Êñ∞
      ElMessage.success('ÂØÜÁ†ÅÂ∑≤Êõ¥Êñ∞')
    }
    
    showEditDialog.value = false
    ElMessage.success('Áî®Êà∑‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞')
    
    // ËÆ∞ÂΩïÂÆ°ËÆ°Êó•Âøó
    let changes = []
    if (oldData.email !== editUserForm.value.email) changes.push(`ÈÇÆÁÆ±‰ªé ${oldData.email} Êîπ‰∏∫ ${editUserForm.value.email}`)
    if (oldData.role !== editUserForm.value.role) changes.push(`ËßíËâ≤‰ªé ${oldData.role} Êîπ‰∏∫ ${editUserForm.value.role}`)
    if (oldData.status !== editUserForm.value.status) changes.push(`Áä∂ÊÄÅ‰ªé ${oldData.status} Êîπ‰∏∫ ${editUserForm.value.status}`)
    if (editUserForm.value.password) changes.push('ÂØÜÁ†ÅÂ∑≤‰øÆÊîπ')
    
    if (changes.length > 0) {
      addAuditLog('‰øÆÊîπÁî®Êà∑', 'admin', editUserForm.value.username, changes.join('; '))
    }
  }
}

const handleDelete = (user) => {
  ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ ${user.username} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
    'ÂÆâÂÖ®Ë≠¶Âëä',
    {
      confirmButtonText: 'Á°ÆËÆ§Âà†Èô§',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning',
      customClass: 'security-confirm'
    }
  ).then(() => {
    users.value = users.value.filter(u => u.id !== user.id)
    ElMessage.success('Áî®Êà∑Â∑≤Âà†Èô§')
    addAuditLog('Âà†Èô§Áî®Êà∑', 'admin', user.username, `Âà†Èô§‰∫ÜÁî®Êà∑ ${user.username}`)
  }).catch(() => {
    ElMessage.info('Â∑≤ÂèñÊ∂àÂà†Èô§')
  })
}

const handleStatusChange = (user) => {
  ElMessage.success(`Áî®Êà∑ ${user.username} Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫ ${user.status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}`)
  addAuditLog('‰øÆÊîπÁä∂ÊÄÅ', 'admin', user.username, `Â∞ÜÁî®Êà∑Áä∂ÊÄÅ‰øÆÊîπ‰∏∫ ${user.status}`)
}

const getRoleTagType = (role) => {
  switch (role) {
    case 'admin': return 'danger'
    case 'operator': return 'primary'
    case 'auditor': return 'warning'
    default: return 'info'
  }
}

const tableRowClassName = ({ row }) => {
  return row.status === 'inactive' ? 'inactive-row' : ''
}

const addAuditLog = (action, operator, target, details) => {
  auditLogs.value.unshift({
    time: new Date().toLocaleString(),
    action,
    operator,
    target,
    details
  })
}

const showAuditLogDialog = () => {
  showAuditLog.value = true
}

// ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
onMounted(() => {
  fetchUsers()
})

// ÁõëÂê¨ÂØÜÁ†ÅÂèòÂåñ
watch(() => newUserForm.value.password, (newVal) => {
  if (newVal && newVal.length > 0) {
    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂØÜÁ†ÅÂº∫Â∫¶Ê£ÄÊü•ÈÄªËæë
  }
})
</script>

<style lang="scss" scoped>
@use './UserManagement.scss';
</style>